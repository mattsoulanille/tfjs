steps:
  - name: gcr.io/learnjs-174218/release
    entrypoint: yarn
    id: yarn-common
    args:
      - install
  - name: gcr.io/learnjs-174218/release
    dir: scripts
    id: test-generate-cloudbuild
    entrypoint: yarn
    args:
      - test-generate-cloudbuild
    waitFor:
      - yarn-common
  - name: gcr.io/learnjs-174218/release
    id: test-run-flaky
    entrypoint: yarn
    args:
      - test-run-flaky
    waitFor:
      - yarn-common
  - name: gcr.io/learnjs-174218/release
    id: buildifier
    entrypoint: yarn
    args:
      - buildifier-ci
    waitFor:
      - yarn-common
  - name: gcr.io/learnjs-174218/release
    id: tslint
    entrypoint: yarn
    args:
      - lint
    waitFor:
      - yarn-common
  - name: gcr.io/learnjs-174218/release
    id: bazel-tests
    waitFor:
      - yarn-common
    entrypoint: bash
    args:
      - ./scripts/run_bazel_ci_tests.sh
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
  - name: gcr.io/learnjs-174218/release
    dir: link-package
    entrypoint: yarn
    id: yarn-link-package
    args:
      - install
    waitFor:
      - bazel-tests
  - name: gcr.io/learnjs-174218/release
    dir: link-package
    entrypoint: yarn
    id: yarn-link-package-build
    args:
      - build
      - '--bazel_options=--config=ci'
    waitFor:
      - yarn-link-package
  - name: gcr.io/learnjs-174218/release
    dir: tfjs
    entrypoint: yarn
    id: yarn-tfjs
    args:
      - install
    waitFor:
      - yarn-common
      - yarn-link-package-build
  - name: gcr.io/learnjs-174218/release
    dir: tfjs
    entrypoint: yarn
    id: build-tfjs
    args:
      - build-ci
    waitFor:
      - yarn-tfjs
      - yarn-common
      - yarn-link-package-build
  - name: gcr.io/learnjs-174218/release
    dir: tfjs
    entrypoint: yarn
    id: lint-tfjs
    args:
      - lint
    waitFor:
      - yarn-tfjs
      - yarn-common
      - yarn-link-package-build
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: yarn-tfjs-node
    args:
      - install
    waitFor:
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: build-addon-tfjs-node
    args:
      - build-addon-from-source
    waitFor:
      - yarn-tfjs-node
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: build-tfjs-node
    args:
      - build-ci
    waitFor:
      - yarn-tfjs-node
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: lint-tfjs-node
    args:
      - lint
    waitFor:
      - yarn-tfjs-node
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: test-tfjs-node
    args:
      - test-ci
    waitFor:
      - yarn-tfjs-node
      - lint-tfjs-node
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: tfjs-node
    entrypoint: yarn
    id: ensure-cpu-gpu-packages-align-tfjs-node
    args:
      - ensure-cpu-gpu-packages-align
    waitFor:
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
  - name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: yarn
    id: yarn-e2e
    args:
      - install
    waitFor:
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-custom-bundles-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: yarn
    args:
      - test-ci
    waitFor:
      - yarn-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-webpack-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e/webpack_test
    entrypoint: bash
    args:
      - '-eEuo'
      - pipefail
      - '-c'
      - |-
        yarn
        yarn build
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-win-10-chrome-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=win_10_chrome --tags
        "#SMOKE,#REGRESSION"
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-script-tag-bundles-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn karma start ./script_tag_tests/tfjs/karma.conf.js --browserstack
        --browsers=bs_chrome_mac --testBundle tf.min.js
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-ios-12-webgl-1-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=bs_ios_12 --tags '#SMOKE,#REGRESSION'
        --testEnv webgl --flags '{"WEBGL_VERSION": 1, "WEBGL_CPU_FORWARD":
        false, "WEBGL_SIZE_UPLOAD_UNIFORM": 0}'
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-safari-mac-webgl-1-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=bs_safari_mac --tags
        '#SMOKE,#REGRESSION' --testEnv webgl --flags '{"WEBGL_VERSION": 1,
        "WEBGL_CPU_FORWARD": false, "WEBGL_SIZE_UPLOAD_UNIFORM": 0}'
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-firefox-mac-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=bs_firefox_mac --tags
        "#SMOKE,#REGRESSION"
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-chrome-mac-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=bs_chrome_mac --tags
        "#SMOKE,#REGRESSION"
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-android-10-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn run-browserstack --browsers=bs_android_10 --tags
        "#SMOKE,#REGRESSION"
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
  - id: test-core-cpu-script-tag-bundles-e2e
    name: gcr.io/learnjs-174218/release
    dir: e2e
    entrypoint: node
    args:
      - ../scripts/run_flaky.js
      - >-
        yarn karma start ./script_tag_tests/tfjs-core-cpu/karma.conf.js
        --browserstack --browsers=bs_chrome_mac
    env:
      - BROWSERSTACK_USERNAME=deeplearnjs1
      - NIGHTLY=$_NIGHTLY
    secretEnv:
      - BROWSERSTACK_KEY
    waitFor:
      - yarn-e2e
      - test-custom-bundles-e2e
      - yarn-common
      - yarn-link-package-build
      - yarn-tfjs
      - build-tfjs
      - lint-tfjs
      - yarn-tfjs-node
      - build-addon-tfjs-node
      - build-tfjs-node
      - lint-tfjs-node
      - ensure-cpu-gpu-packages-align-tfjs-node
secrets:
  - kmsKeyName: projects/learnjs-174218/locations/global/keyRings/tfjs/cryptoKeys/enc
    secretEnv:
      BROWSERSTACK_KEY: >-
        CiQAkwyoIW0LcnxymzotLwaH4udVTQFBEN4AEA5CA+a3+yflL2ASPQAD8BdZnGARf78MhH5T9rQqyz9HNODwVjVIj64CTkFlUCGrP1B2HX9LXHWHLmtKutEGTeFFX9XhuBzNExA=
timeout: 7200s
logsBucket: 'gs://tfjs-build-logs'
substitutions:
  _NIGHTLY: ''
options:
  logStreamingOption: STREAM_ON
  machineType: N1_HIGHCPU_32
  substitution_option: ALLOW_LOOSE
